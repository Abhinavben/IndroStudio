<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Website...</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f3f4f6; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; margin: 0; flex-direction: column; }
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { margin-top: 15px; color: #666; font-weight: 500; }
        
        /* Ad Banner Style */
        .indro-github-ad { background:#111; color:white; padding:12px; text-align:center; font-weight:bold; cursor:pointer; width:100%; box-sizing:border-box; display:block; text-decoration:none; }
        .indro-github-ad:hover { background:black; }
    </style>
</head>
<body>

    <div id="loader-ui" style="text-align:center;">
        <div class="loader"></div>
        <p>Opening Website...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC07JemT3VQQoDSOpARelJkcsqaWEO0vDI",
            authDomain: "indronetwork.firebaseapp.com",
            projectId: "indronetwork",
            storageBucket: "indronetwork.firebasestorage.app",
            messagingSenderId: "410515803868",
            appId: "1:410515803868:web:6c16375390301a34686e19"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function load() {
            const id = new URLSearchParams(window.location.search).get('id');
            if(!id) return document.body.innerHTML = "<h3>Error: Invalid ID</h3>";

            try {
                // 1. Fetch Client Data from Firebase
                const docRef = doc(db, "clients", id);
                const snap = await getDoc(docRef);

                if(snap.exists()) {
                    const d = snap.data();
                    let adHTML = "";

                    // 2. CHECK: If NOT Premium -> Fetch GitHub Ads
                    if(!d.isPremium) {
                        try {
                            const res = await fetch("https://raw.githubusercontent.com/Abhinavben/Indro-network/main/ads.json");
                            const ads = await res.json();
                            
                            // Logic to find the correct AD
                            let myKey = d.key || 'default'; // Get key from Firebase
                            let myAd = ads.find(a => a.key === myKey);
                            
                            // Fallback 1: Try Category (e.g. gym_1)
                            if(!myAd && myKey.includes('_')) {
                                myAd = ads.find(a => a.key === (myKey.split('_')[0] + "_1"));
                            }
                            // Fallback 2: Default
                            if(!myAd) myAd = ads.find(a => a.key === 'default');

                            if(myAd && myAd.ad_config) {
                                adHTML = `<div class="indro-github-ad" style="background:${myAd.ad_config.bg}; color:${myAd.ad_config.color}" onclick="window.open('${myAd.ad_config.link}')">
                                    ðŸ“¢ ${myAd.ad_config.text}
                                </div>`;
                            }
                        } catch(e) { console.log("Ad Error: " + e); }
                    }

                    render(d, adHTML);
                } else {
                    document.body.innerHTML = "<h3>Site Not Found</h3>";
                }
            } catch(e) { 
                console.error(e);
                document.body.innerHTML = "<h3>Server Error</h3>"; 
            }
        }

        function render(d, adHTML) {
            const tick = d.isPremium ? '<i class="fa-solid fa-circle-check" style="color:#2563eb; margin-left:5px;" title="Verified"></i>' : '';
            
            // Social Links
            let socialHTML = "";
            if(d.insta) socialHTML += `<a href="${d.insta}" target="_blank"><i class="fa-brands fa-instagram"></i> Instagram</a>`;
            if(d.fb) socialHTML += `<a href="${d.fb}" target="_blank"><i class="fa-brands fa-facebook"></i> Facebook</a>`;

            // Gallery
            let galleryHTML = "";
            if(d.img1||d.img2||d.img3) {
                let imgs = "";
                if(d.img1) imgs+=`<img src="${d.img1}" class="g-img">`;
                if(d.img2) imgs+=`<img src="${d.img2}" class="g-img">`;
                if(d.img3) imgs+=`<img src="${d.img3}" class="g-img">`;
                galleryHTML = `<section class="sec"><h2>Gallery</h2><div class="g-grid">${imgs}</div></section>`;
            }

            // FULL SITE HTML
            const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${d.name}</title>
                <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    :root { --p: #111; --acc: #4f46e5; --bg: #fff; --txt: #333; }
                    body { margin:0; font-family:'Outfit',sans-serif; background:white; display:block; height:auto; }
                    .header { padding:20px 5%; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; position:sticky; top:0; background:rgba(255,255,255,0.95); z-index:100; }
                    .logo { font-family:'Space Grotesk'; font-weight:800; font-size:22px; display:flex; align-items:center; }
                    .hero { padding:80px 20px; text-align:center; background:#111; color:white; }
                    .btn { padding:15px 35px; background:#4f46e5; color:white; border-radius:50px; text-decoration:none; display:inline-block; margin-top:15px; font-weight:bold; }
                    .sec { padding:60px 5%; text-align:center; }
                    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-top:30px; }
                    .card { padding:30px; border:1px solid #eee; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05); }
                    .g-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px; margin-top:20px; }
                    .g-img { width:100%; height:200px; object-fit:cover; border-radius:10px; }
                    footer { background:#000; color:#888; padding:40px 5%; text-align:center; }
                    .links a { color:#888; margin:0 10px; text-decoration:none; display:inline-flex; align-items:center; gap:5px; }
                    
                    /* Chatbot & Particles */
                    #particles { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0.3; pointer-events:none; }
                    .chat-bubble { position:fixed; bottom:20px; right:20px; width:50px; height:50px; background:var(--acc); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 10px 20px rgba(0,0,0,0.2); z-index:999; }
                    .chat-win { position:fixed; bottom:80px; right:20px; width:300px; height:400px; background:white; border-radius:15px; box-shadow:0 10px 40px rgba(0,0,0,0.2); display:none; flex-direction:column; overflow:hidden; z-index:999; }
                    .cw-head { padding:15px; background:var(--acc); color:white; font-weight:bold; display:flex; justify-content:space-between; }
                    .cw-body { flex:1; padding:10px; overflow-y:auto; background:#f9fafb; font-size:13px; }
                    .cw-in { padding:10px; border-top:1px solid #eee; display:flex; }
                    .cw-in input { flex:1; border:1px solid #ddd; padding:5px 10px; border-radius:20px; outline:none; }
                    .msg { padding:8px 12px; border-radius:10px; margin-bottom:5px; max-width:80%; }
                    .ai { background:white; border:1px solid #eee; align-self:flex-start; }
                    .user { background:var(--acc); color:white; align-self:flex-end; margin-left:auto; }
                </style>
            </head>
            <body>
                ${adHTML}
                
                <div class="header">
                    <div class="logo">${d.name} ${tick}</div>
                    <a href="https://wa.me/${d.phone}" class="btn" style="margin:0; padding:10px 20px; font-size:14px;">Contact</a>
                </div>

                <div class="hero" style="position:relative;">
                    <canvas id="particles"></canvas>
                    <h1 style="position:relative; z-index:2;">${d.name}</h1>
                    <p style="opacity:0.8; max-width:600px; margin:10px auto; position:relative; z-index:2;">${d.desc}</p>
                    <a href="tel:${d.phone}" class="btn" style="position:relative; z-index:2;">Call Now</a>
                </div>

                <div class="sec">
                    <h2>Our Services</h2>
                    <div class="grid">
                        <div class="card"><h3>${d.s1}</h3><p>Top Quality.</p></div>
                        <div class="card"><h3>${d.s2}</h3><p>Best Service.</p></div>
                        <div class="card"><h3>${d.s3}</h3><p>Trusted.</p></div>
                    </div>
                </div>

                ${galleryHTML}

                <div class="sec" style="background:#f9fafb;">
                    <h2>Reviews</h2>
                    <div class="grid">
                        <div class="card">"Best in ${d.loc}!" <br><b>- Amit K.</b></div>
                        <div class="card">"Great experience." <br><b>- Rahul S.</b></div>
                    </div>
                </div>
                
                <div class="sec">
                    <h2>Location</h2>
                    <p><i class="fa-solid fa-location-dot"></i> ${d.loc}</p>
                </div>

                <footer>
                    <h3>${d.name}</h3>
                    <div class="links" style="margin:20px 0;">${socialHTML}</div>
                    <p style="font-size:12px;">POWERED BY INDRO NETWORK</p>
                </footer>

                <div class="chat-win" id="cw">
                    <div class="cw-head"><span>Support AI</span><span onclick="document.getElementById('cw').style.display='none'" style="cursor:pointer">x</span></div>
                    <div class="cw-body" id="cb"><div class="msg ai">Hello! How can I help?</div></div>
                    <div class="cw-in"><input id="ci" placeholder="Type..." onkeypress="if(event.key=='Enter')send()"><button onclick="send()" style="border:none; background:none;">ðŸš€</button></div>
                </div>
                <div class="chat-bubble" onclick="document.getElementById('cw').style.display='flex'"><i class="fa-solid fa-comment"></i></div>

                <script src="https://apifreellm.com/apifree.min.js"><\/script>
                <script>
                    const cvs=document.getElementById('particles'),ctx=cvs.getContext('2d');
                    cvs.width=window.innerWidth;cvs.height=window.innerHeight;
                    const p=[];for(let i=0;i<50;i++)p.push({x:Math.random()*cvs.width,y:Math.random()*cvs.height,vx:Math.random()-0.5,vy:Math.random()-0.5});
                    function anim(){ctx.clearRect(0,0,cvs.width,cvs.height);ctx.fillStyle='rgba(255,255,255,0.2)';p.forEach(e=>{e.x+=e.vx;e.y+=e.vy;if(e.x<0||e.x>cvs.width)e.vx*=-1;if(e.y<0||e.y>cvs.height)e.vy*=-1;ctx.beginPath();ctx.arc(e.x,e.y,2,0,Math.PI*2);ctx.fill()});requestAnimationFrame(anim)}anim();

                    async function send(){
                        const i=document.getElementById('ci'),v=i.value;
                        if(!v)return;
                        add(v,'user');i.value='';
                        try{
                            const r=await apifree.chat("You are AI for ${d.name}. Help user: "+v);
                            add(r,'ai');
                        }catch(e){add("Please WhatsApp us.",'ai')}
                    }
                    function add(t,c){const d=document.createElement('div');d.className='msg '+c;d.innerText=t;document.getElementById('cb').append(d);}
                <\/script>
            </body>
            </html>
            `;
            document.open();
            document.write(html);
            document.close();
        }

        load();
    </script>
</body>
</html>
